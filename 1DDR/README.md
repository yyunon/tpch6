# Fletcher AWS F1 design with 1 DDR DIMM

1. [Overview](#overview)
2. [Functional Description of the example RTL](#functionalDescription)
3. [Software](#software)
4. [DRAM DMA Example Metadata](#metadata)


<a name="overview"></a>
# Overview  

This Fletcher design is based on the CL_DRAM_DMA CustomLogic Example with 1 DDR controllers.
In this version of the design, most of the example logic is removed.
The AxiTop generated by Fletcher is connected to the 2nd AXI master interface on the interconnect
to the DDR controller (replacing the AXI master test component), 
and the BAR1 AXI-Lite register interface.
The AXI interconnect IP used in this design is different from the default - it has only 1 master interface
(connecting to the DDR AXI bus that enters the shell directly) and 2 slaves (for the AxiTop and PCI slave access from the host).
The memory scrubbing and testing components have been removed.


1) Register Access over the BAR1 AXI-Lite interface

2) Mapping of the external DRAM channel to instance memory via PCIe AppPF BAR4, and the 512-bit pcis_dma_ AXI4 bus

3) Virtual JTAG and Xilinx Integrated Logic Analyzer cores


<a name="functionalDescription"></a>
# Functional Description

### DRAM Interfaces

One DRAM channels is used.
The DRAM space is 16GiB, and is mapped to the sh_cl_dma_pcis AXI4 bus.

<a name="dma_pcis"></a>
### dma_pcis AXI4 bus

sh\_cl\_dma\_pcis exposes a address windows of 128GiB matching AppPF BAR4.


This memory space is mapped to the 16GiB DRAM space (wrapping) of 1 DDR DIMM.
An [axi_crossbar_0](ip/cl_axi_interconnect_1m2s/synth/cl_axi_interconnect.v) will arbitrate between the 2 master interfaces
connected to the PCIe and the custom logic AXI master bus.


### BAR1 AXI-Lite

The BAR1 AXI-Lite bus is connected to the Fletcher MMIO control register interface.

### Virtual JTAG

2 ILA cores are integrated, one to monitoring the sh\_c_dma\_pcis bus and the other to monitor the AXI4 signals on DDR_A. An example usage is provided in [cl_ila.sv](design/cl_ila.sv).
An example usage for Xilinx VIO is provided in [cl_vio.sv](design/cl_vio.sv)


### Clocks

The design uses the main `clk_main_a0`.  Its frequency is set in the cl_clk under `build/constraints/cl_clocks.xdc`.

`clk_xtra_a1` is used by the Virtual JTAG

### Reset

flr_reset is ignored in this design
  

<a name="software"></a>
## Runtime software
DMA accesses rely on the [XDMA driver](../../../../sdk/linux_kernel_drivers/xdma/README.md)

Developers using AMI 1.5.0 or Later Instances that come with pre-installed Xilinx Runtime Environment (XRT) should [refer to this note](../../../../sdk/linux_kernel_drivers/xdma/xdma_install.md#xdmainstallfail) before installing the XDMA driver.

The runtime example is located in the software/runtime directory of the specific Fletcher-aws example.

## Compile and run instructions

Build (using `make`) and run the software in the $CL_DIR/software/runtime


The test can be simulated with XSIM as follows.

cd $CL_DIR/verif/scripts
make C_TEST=<runtime_program_name> (excluding .cpp suffix)

<a name="metadata"></a>
## Fletcher AWS example Metadata
The following table displays information about the CL that is required to register it as an AFI with AWS.
Alternatively, you can directly use a pre-generated AFI for this CL.

| Key   | Value     |
|-----------|------|
| Shell Version | 0x04261818 |
| PCI Device ID | 0xF001 |
| PCI Vendor ID | 0x1D0F (Amazon) |
| PCI Subsystem ID | 0x1D51 |
| PCI Subsystem Vendor ID | 0xFEDC |
